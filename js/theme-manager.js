/**
 * THEME MANAGER INTEGRADO - SISTEMA DE GESTI√ìN DE TEMAS
 * BGE H√©roes de la Patria - Integraci√≥n con sistema existente
 *
 * Mejora el sistema existente de modo oscuro con:
 * - Detecci√≥n autom√°tica de preferencias del sistema
 * - Variables CSS avanzadas
 * - Mejor accesibilidad y transiciones
 * - Sincronizaci√≥n entre pesta√±as
 */

class IntegratedThemeManager {
    constructor() {
        console.log('üåô [THEME] Inicializando Theme Manager Integrado...');

        // Configuraci√≥n integrada con sistema existente
        this.storageKey = 'heroesPatria_darkMode'; // Usar el key existente
        this.existingClass = 'dark-mode'; // Usar la clase CSS existente
        this.toggleSelector = '#darkModeToggle'; // Usar el bot√≥n flotante existente

        // Media query para detecci√≥n del sistema
        this.mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');

        // Referencias DOM
        this.body = document.body;
        this.html = document.documentElement;
        this.toggleButton = null;

        // Estado
        this.isSystemDark = this.mediaQuery.matches;
        this.hasUserPreference = localStorage.getItem(this.storageKey) !== null;

        // Inicializar cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => this.init());
        } else {
            this.init();
        }
    }

    /**
     * Inicializaci√≥n del sistema integrado
     */
    init() {
        try {
            // Detectar y aplicar tema basado en preferencias
            this.detectAndApplyTheme();

            // Configurar el bot√≥n toggle existente
            this.setupExistingToggle();

            // Configurar listeners para cambios del sistema
            this.setupSystemListener();

            // Configurar sincronizaci√≥n entre pesta√±as
            this.setupStorageSync();

            // Aplicar mejoras CSS
            this.applyEnhancedCSS();

            console.log('‚úÖ [THEME] Theme Manager Integrado inicializado correctamente');

            // Evento personalizado de inicializaci√≥n
            this.dispatchEvent('themeManagerReady', {
                isDark: this.isDarkMode(),
                isSystemDark: this.isSystemDark,
                hasUserPreference: this.hasUserPreference
            });

        } catch (error) {
            console.error('‚ùå [THEME] Error inicializando Theme Manager:', error);
        }
    }

    /**
     * Detecta y aplica el tema correcto
     */
    detectAndApplyTheme() {
        // Si el usuario no ha establecido preferencia, usar la del sistema
        if (!this.hasUserPreference && this.isSystemDark) {
            console.log('üåô [THEME] Aplicando modo oscuro autom√°tico (sistema)');
            this.body.classList.add(this.existingClass);
            localStorage.setItem(this.storageKey, 'true');
        }

        // Aplicar data-theme para usar variables CSS avanzadas
        const isDark = this.isDarkMode();
        this.html.setAttribute('data-theme', isDark ? 'dark' : 'light');

        console.log(`üé® [THEME] Tema aplicado: ${isDark ? 'oscuro' : 'claro'}`);
    }

    /**
     * Configura el bot√≥n toggle existente
     */
    setupExistingToggle() {
        // Buscar el bot√≥n existente con m√∫ltiples intentos
        const findToggle = () => {
            this.toggleButton = document.querySelector(this.toggleSelector);
            return this.toggleButton !== null;
        };

        if (findToggle()) {
            this.enhanceToggleButton();
        } else {
            // Reintentar hasta encontrarlo (m√°ximo 10 segundos)
            let attempts = 0;
            const maxAttempts = 20;

            const interval = setInterval(() => {
                attempts++;
                if (findToggle()) {
                    clearInterval(interval);
                    this.enhanceToggleButton();
                } else if (attempts >= maxAttempts) {
                    clearInterval(interval);
                    console.warn('‚ö†Ô∏è [THEME] No se encontr√≥ el bot√≥n toggle despu√©s de 10s');
                }
            }, 500);
        }
    }

    /**
     * Mejora el bot√≥n toggle existente
     */
    enhanceToggleButton() {
        if (!this.toggleButton) return;

        console.log('üîò [THEME] Mejorando bot√≥n toggle existente');

        // Actualizar icono inicial
        this.updateToggleIcon();

        // Remover listeners previos y a√±adir el nuestro
        const newButton = this.toggleButton.cloneNode(true);
        this.toggleButton.parentNode.replaceChild(newButton, this.toggleButton);
        this.toggleButton = newButton;

        // A√±adir nuestro listener mejorado
        this.toggleButton.addEventListener('click', () => this.toggleTheme());

        // Mejorar accesibilidad
        this.toggleButton.setAttribute('title', this.isDarkMode() ? 'Cambiar a modo claro' : 'Cambiar a modo oscuro');
    }

    /**
     * Alterna el tema
     */
    toggleTheme() {
        const wasWasDark = this.isDarkMode();
        const newDarkState = !wasWasDark;

        console.log(`üîÑ [THEME] Cambiando tema: ${wasWasDark ? 'claro' : 'oscuro'} ‚Üí ${newDarkState ? 'oscuro' : 'claro'}`);

        // Aplicar transici√≥n suave
        this.body.style.transition = 'background-color 0.3s ease, color 0.3s ease';
        this.html.style.transition = 'background-color 0.3s ease, color 0.3s ease';

        // Cambiar clase existente
        this.body.classList.toggle(this.existingClass, newDarkState);

        // Cambiar data-theme para variables CSS avanzadas
        this.html.setAttribute('data-theme', newDarkState ? 'dark' : 'light');

        // Guardar preferencia
        localStorage.setItem(this.storageKey, newDarkState.toString());
        this.hasUserPreference = true;

        // Actualizar icono
        this.updateToggleIcon();

        // Remover transici√≥n despu√©s de completarse
        setTimeout(() => {
            this.body.style.transition = '';
            this.html.style.transition = '';
        }, 300);

        // Evento personalizado
        this.dispatchEvent('themeChanged', {
            isDark: newDarkState,
            wasSystemTriggered: false
        });
    }

    /**
     * Actualiza el icono del toggle
     */
    updateToggleIcon() {
        if (!this.toggleButton) return;

        const icon = this.toggleButton.querySelector('i');
        const isDark = this.isDarkMode();

        if (icon) {
            icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }

        this.toggleButton.setAttribute('aria-label', isDark ? 'Cambiar a modo claro' : 'Cambiar a modo oscuro');
        this.toggleButton.setAttribute('title', isDark ? 'Cambiar a modo claro' : 'Cambiar a modo oscuro');
    }

    /**
     * Configura listener para cambios en preferencias del sistema
     */
    setupSystemListener() {
        this.mediaQuery.addEventListener('change', (e) => {
            this.isSystemDark = e.matches;
            console.log(`üîÑ [THEME] Cambio en preferencia del sistema: ${e.matches ? 'oscuro' : 'claro'}`);

            // Si el usuario no ha establecido preferencia, seguir al sistema
            if (!this.hasUserPreference) {
                const newDarkState = e.matches;
                this.body.classList.toggle(this.existingClass, newDarkState);
                this.html.setAttribute('data-theme', newDarkState ? 'dark' : 'light');
                this.updateToggleIcon();

                this.dispatchEvent('themeChanged', {
                    isDark: newDarkState,
                    wasSystemTriggered: true
                });
            }
        });
    }

    /**
     * Configura sincronizaci√≥n entre pesta√±as
     */
    setupStorageSync() {
        window.addEventListener('storage', (e) => {
            if (e.key === this.storageKey && e.newValue !== e.oldValue) {
                console.log('üîÑ [THEME] Sincronizaci√≥n entre pesta√±as');
                const newDarkState = e.newValue === 'true';
                this.body.classList.toggle(this.existingClass, newDarkState);
                this.html.setAttribute('data-theme', newDarkState ? 'dark' : 'light');
                this.updateToggleIcon();
            }
        });
    }

    /**
     * Aplica mejoras CSS din√°micamente
     */
    applyEnhancedCSS() {
        // Solo aplicar si themes.css no est√° ya cargado
        if (!document.querySelector('link[href*="themes.css"]')) {
            const themeLink = document.createElement('link');
            themeLink.rel = 'stylesheet';
            themeLink.href = 'css/themes.css';
            document.head.appendChild(themeLink);
            console.log('üìÑ [THEME] CSS de temas cargado din√°micamente');
        }
    }

    /**
     * Verifica si est√° en modo oscuro
     */
    isDarkMode() {
        return this.body.classList.contains(this.existingClass);
    }

    /**
     * Dispara eventos personalizados
     */
    dispatchEvent(eventName, detail) {
        const event = new CustomEvent(eventName, {
            detail: {
                ...detail,
                timestamp: new Date().toISOString(),
                manager: this
            }
        });

        window.dispatchEvent(event);
        console.log(`üì° [THEME] Evento: ${eventName}`, detail);
    }

    /**
     * API p√∫blica para obtener informaci√≥n del tema
     */
    getThemeInfo() {
        return {
            isDark: this.isDarkMode(),
            isSystemDark: this.isSystemDark,
            hasUserPreference: this.hasUserPreference,
            storageKey: this.storageKey
        };
    }

    /**
     * M√©todo para debugging
     */
    debug() {
        console.group('üêõ [THEME] Debug Info');
        console.log('Is dark mode:', this.isDarkMode());
        console.log('System prefers dark:', this.isSystemDark);
        console.log('Has user preference:', this.hasUserPreference);
        console.log('Toggle button:', this.toggleButton);
        console.groupEnd();
    }
}

// ==============================================
// INICIALIZACI√ìN AUTOM√ÅTICA
// ==============================================

// Solo inicializar si no existe ya una instancia
if (!window.integratedThemeManager) {
    window.integratedThemeManager = new IntegratedThemeManager();

    // M√©todo de conveniencia global
    window.toggleTheme = () => window.integratedThemeManager.toggleTheme();

    console.log('üé® [THEME] Theme Manager Integrado disponible globalmente');
}

// Exportar para m√≥dulos
if (typeof module !== 'undefined' && module.exports) {
    module.exports = IntegratedThemeManager;
}

console.log('üìÅ [THEME] theme-manager.js integrado cargado exitosamente');