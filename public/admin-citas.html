<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administración de Citas | BGE Héroes de la Patria</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">

    <style>
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .action-card {
            background: #fff;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        .action-card:hover {
            transform: translateY(-5px);
        }
        .action-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- Header will be injected here -->
    <header id="main-header"></header>

    <!-- Main Content -->
    <div class="container my-5">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <h1 class="display-4 text-primary mb-3">
                    <i class="fas fa-calendar-alt me-3"></i>
                    Administración de Citas
                </h1>
                <p class="lead text-muted">Gestiona y visualiza todas las citas programadas del bachillerato</p>
            </div>
        </div>

        <!-- Estadísticas -->
        <div class="row mb-5" id="statsContainer">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number" id="totalCitas">-</div>
                    <div>Total de Citas</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number" id="citasHoy">-</div>
                    <div>Citas Hoy</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number" id="citasManana">-</div>
                    <div>Citas Mañana</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number" id="citasActivasCount">-</div>
                    <div>Citas Activas</div>
                </div>
            </div>
        </div>

        <!-- Acciones Principales -->
        <div class="row mb-5">
            <div class="col-md-4">
                <div class="action-card">
                    <div class="action-icon text-primary">
                        <i class="fas fa-list-alt"></i>
                    </div>
                    <h4>Ver Todas las Citas</h4>
                    <p class="text-muted">Visualiza, busca y gestiona todas las citas programadas</p>
                    <button class="btn btn-primary" onclick="showAllAppointments()">
                        <i class="fas fa-eye me-1"></i>Ver Citas
                    </button>
                </div>
            </div>
            <div class="col-md-4">
                <div class="action-card">
                    <div class="action-icon text-success">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h4>Estadísticas Detalladas</h4>
                    <p class="text-muted">Revisa métricas y estadísticas de citas por departamento</p>
                    <button class="btn btn-success" onclick="showDetailedStats()">
                        <i class="fas fa-chart-line me-1"></i>Ver Estadísticas
                    </button>
                </div>
            </div>
            <div class="col-md-4">
                <div class="action-card">
                    <div class="action-icon text-info">
                        <i class="fas fa-download"></i>
                    </div>
                    <h4>Exportar Datos</h4>
                    <p class="text-muted">Descarga un archivo CSV con todas las citas</p>
                    <button class="btn btn-info" onclick="exportAppointments()">
                        <i class="fas fa-file-csv me-1"></i>Exportar CSV
                    </button>
                </div>
            </div>
        </div>

        <!-- Departamentos más activos -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-building me-2"></i>
                            Citas por Departamento
                        </h5>
                    </div>
                    <div class="card-body" id="departmentStats">
                        <p class="text-muted">Cargando estadísticas por departamento...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug Info -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Información del Sistema
                        </h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Almacenamiento:</strong> localStorage del navegador (clave: 'appointments_bge')</p>
                        <p><strong>Última actualización:</strong> <span id="lastUpdate">-</span></p>
                        <button class="btn btn-sm btn-outline-secondary" onclick="checkLocalStorage()">
                            <i class="fas fa-database me-1"></i>Verificar LocalStorage
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="clearAllAppointments()">
                            <i class="fas fa-trash me-1"></i>Limpiar Todas las Citas
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/appointments.js"></script>

    <script>
        // Variable global para el sistema de citas
        let appointmentSystem;

        // Inicialización cuando se carga la página
        document.addEventListener('DOMContentLoaded', function() {
            initializeAdminPanel();
        });

        function initializeAdminPanel() {
            // Crear instancia del sistema de citas
            appointmentSystem = new AppointmentSystem();

            // Cargar estadísticas
            loadStats();

            // Actualizar información del sistema
            updateSystemInfo();
        }

        function loadStats() {
            const stats = appointmentSystem.getAppointmentStats();

            // Actualizar contadores principales
            document.getElementById('totalCitas').textContent = stats.total;
            document.getElementById('citasHoy').textContent = stats.today;
            document.getElementById('citasManana').textContent = stats.tomorrow;

            // Contar citas activas (futuras)
            const today = new Date();
            const activeCitas = appointmentSystem.getAllAppointments().filter(apt =>
                new Date(apt.date) >= today
            ).length;
            document.getElementById('citasActivasCount').textContent = activeCitas;

            // Mostrar estadísticas por departamento
            updateDepartmentStats(stats.byDepartment);
        }

        function updateDepartmentStats(byDepartment) {
            const container = document.getElementById('departmentStats');

            if (Object.keys(byDepartment).length === 0) {
                container.innerHTML = '<p class="text-muted">No hay citas registradas aún.</p>';
                return;
            }

            let html = '<div class="row">';
            Object.entries(byDepartment).forEach(([deptId, count]) => {
                const dept = appointmentSystem.departments.find(d => d.id === deptId);
                const deptName = dept ? dept.name : deptId;
                const deptColor = dept ? dept.color : 'secondary';

                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-${deptColor} me-2" style="font-size: 1rem; padding: 0.5rem;">
                                ${count}
                            </span>
                            <div>
                                <div class="fw-bold">${deptName}</div>
                                <small class="text-muted">${count} cita${count !== 1 ? 's' : ''}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        function updateSystemInfo() {
            const stored = localStorage.getItem('appointments_bge');
            if (stored) {
                const data = JSON.parse(stored);
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString('es-ES');
            } else {
                document.getElementById('lastUpdate').textContent = 'Sin datos';
            }
        }

        // Funciones principales
        function showAllAppointments() {
            if (!appointmentSystem) {
                alert('Sistema no inicializado');
                return;
            }
            appointmentSystem.showAllAppointments();
        }

        function showDetailedStats() {
            const stats = appointmentSystem.getAppointmentStats();
            const allAppointments = appointmentSystem.getAllAppointments();

            let mensaje = `📊 ESTADÍSTICAS DETALLADAS DE CITAS

📅 Resumen General:
• Total de citas: ${stats.total}
• Citas para hoy: ${stats.today}
• Citas para mañana: ${stats.tomorrow}

🏢 Por Departamento:`;

            Object.entries(stats.byDepartment).forEach(([deptId, count]) => {
                const dept = appointmentSystem.departments.find(d => d.id === deptId);
                const deptName = dept ? dept.name : deptId;
                mensaje += `\n• ${deptName}: ${count} citas`;
            });

            // Análisis por estado
            const estados = {
                programadas: 0,
                hoy: 0,
                completadas: 0
            };

            allAppointments.forEach(apt => {
                const status = appointmentSystem.getAppointmentStatus(apt);
                if (status === 'Programada') estados.programadas++;
                else if (status === 'Hoy') estados.hoy++;
                else if (status === 'Completada') estados.completadas++;
            });

            mensaje += `\n\n📈 Por Estado:
• Programadas: ${estados.programadas}
• Para hoy: ${estados.hoy}
• Completadas: ${estados.completadas}`;

            alert(mensaje);
        }

        function exportAppointments() {
            if (!appointmentSystem) {
                alert('Sistema no inicializado');
                return;
            }
            appointmentSystem.exportAppointments();
        }

        function checkLocalStorage() {
            const stored = localStorage.getItem('appointments_bge');
            if (stored) {
                const data = JSON.parse(stored);
                alert(`✅ LocalStorage encontrado:

Clave: 'appointments_bge'
Cantidad de citas: ${data.length}
Tamaño aproximado: ${new Blob([stored]).size} bytes

Última cita registrada:
${data.length > 0 ? JSON.stringify(data[data.length - 1], null, 2) : 'N/A'}`);
            } else {
                alert('❌ No se encontraron datos en localStorage.\n\nEsto significa que no se han agendado citas aún o se han eliminado los datos.');
            }
        }

        function clearAllAppointments() {
            if (!confirm('⚠️ ADVERTENCIA: Esto eliminará TODAS las citas del sistema.\n\n¿Estás completamente seguro de que quieres continuar?')) {
                return;
            }

            if (!confirm('🗑️ CONFIRMACIÓN FINAL: Se eliminarán TODAS las citas permanentemente.\n\nEsta acción NO se puede deshacer.\n\n¿Continuar?')) {
                return;
            }

            localStorage.removeItem('appointments_bge');

            // Reinicializar el sistema
            appointmentSystem = new AppointmentSystem();
            loadStats();
            updateSystemInfo();

            alert('✅ Todas las citas han sido eliminadas del sistema.');
        }

        // Actualizar estadísticas cada 30 segundos
        setInterval(function() {
            if (appointmentSystem) {
                loadStats();
                updateSystemInfo();
            }
        }, 30000);
    </script>

    <!-- Dark Mode Toggle Button (Floating) -->
    <button class="dark-mode-toggle" id="darkModeToggle" aria-label="Alternar modo oscuro">
        <i class="fas fa-moon"></i>
    </button>

    <!-- Chat Bot Toggle Button -->
    <button class="chatbot-toggle" id="chatbotToggle" aria-label="Abrir chat de ayuda">
        <i class="fas fa-comments"></i>
    </button>

    <!-- Chat Bot Container -->
    <div class="chatbot-container" id="chatbotContainer">
        <div class="chatbot-header">
            <div>
                <strong>Asistente Virtual</strong>
                <div style="font-size: 12px; opacity: 0.8;">Héroes de la Patria</div>
            </div>
            <button style="background: none; border: none; color: white; font-size: 18px; position: absolute; top: 10px; right: 15px;" aria-label="Cerrar chat">×</button>
        </div>

        <div class="chatbot-messages" id="chatbotMessages">
            <!-- Los mensajes se cargarán dinámicamente -->
        </div>

        <div id="typingIndicator" class="typing-indicator" style="display: none;">
            <div class="typing-dots">
                <div></div>
                <div></div>
                <div></div>
            </div>
            <span>El asistente está escribiendo...</span>
        </div>

        <div class="chatbot-input">
            <input type="text" id="chatbotInput" placeholder="Escribe tu pregunta..." aria-label="Escribe tu pregunta">
            <button id="chatbotSendBtn" aria-label="Enviar mensaje">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Back to Top -->
    <button id="back-to-top" class="btn btn-primary" aria-label="Volver arriba">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Footer -->
    <footer id="main-footer"></footer>

    <!-- 🚀 BGE FRAMEWORK MODULAR - PÁGINA ADMIN CITAS -->

    <!-- 🔧 SISTEMA CORE (OBLIGATORIO) -->
    <script src="js/context-manager.js"></script>
    <script src="js/config.js?v=2024091401"></script>
    <script src="js/theme-manager.js"></script>
    <script src="js/script.js"></script>

    <!-- 🎯 BGE FRAMEWORK CORE -->
    <script src="js/bge-framework-core.js"></script>

    <!-- 📊 MÓDULOS BGE PARA ADMIN CITAS -->
    <script src="js/bge-analytics-module.js"></script>
    <script src="js/bge-security-module.js"></script>    <!-- 🔒 Seguridad y autenticación admin -->
    <script src="js/bge-pwa-module.js"></script>

    <!-- 🔧 FUNCIONALIDADES ESPECÍFICAS -->
    <script src="js/chatbot.js"></script>
    <script src="js/auth-interface.js"></script>
</body>
</html>