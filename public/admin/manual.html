<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n Manual - Bachillerato H√©roes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .admin-container { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin: 2rem 0; }
        .header-admin { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 2rem; border-radius: 15px 15px 0 0; text-align: center; }
        .admin-option { border: 2px solid #e9ecef; border-radius: 10px; padding: 1.5rem; margin: 1rem 0; transition: all 0.3s; }
        .admin-option:hover { border-color: #2a5298; background: #f8f9fa; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-admin { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 0.75rem 1.5rem; border-radius: 25px; color: white; text-decoration: none; transition: all 0.3s; }
        .btn-admin:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); color: white; }
        .instruction-box { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1rem; margin: 1rem 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="admin-container">
            <div class="header-admin">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1><i class="fas fa-cogs"></i> Panel de Administraci√≥n</h1>
                        <p>Bachillerato General Estatal "H√©roes de la Patria"</p>
                    </div>
                    <div>
                        <div class="session-info text-end mb-2">
                            <small><i class="fas fa-user-shield me-1"></i>Sesi√≥n Administrativa Activa</small>
                        </div>
                        <button onclick="logoutAndClose()" class="btn btn-outline-light btn-sm">
                            <i class="fas fa-sign-out-alt me-1"></i>Cerrar Sesi√≥n
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="p-4">
                <div class="instruction-box">
                    <h5><i class="fas fa-info-circle"></i> Sistema de Administraci√≥n Manual</h5>
                    <p><strong>‚úÖ Configuraci√≥n Completada</strong> - El sistema ha sido configurado para usar edici√≥n manual via GitHub. Los m√©todos autom√°ticos (OAuth/CMS) han sido deshabilitados por problemas de compatibilidad.</p>
                </div>

                <!-- OPCI√ìN 1: GitHub Direct -->
                <div class="admin-option">
                    <h4><i class="fab fa-github"></i> Opci√≥n 1: Editar directamente en GitHub <span class="badge bg-success">Recomendado</span></h4>
                    <p>La forma m√°s simple y directa de editar el contenido:</p>
                    <ol>
                        <li>Ve a tu repositorio: <code>SACRINT/heroes_de_la_patria_oficial</code></li>
                        <li>Navega a la carpeta <code>data/</code></li>
                        <li>Haz clic en el archivo que quieres editar (ej: <code>testimonios.json</code>)</li>
                        <li>Haz clic en el √≠cono del l√°piz <i class="fas fa-edit"></i> para editar</li>
                        <li>Modifica el contenido en formato JSON</li>
                        <li>Haz clic en "Commit changes"</li>
                        <li>¬°Los cambios aparecer√°n autom√°ticamente en tu sitio web!</li>
                    </ol>
                    <a href="https://github.com/SACRINT/heroes_de_la_patria_oficial/tree/main/data" target="_blank" class="btn btn-admin">
                        <i class="fab fa-github"></i> Ir a GitHub
                    </a>
                </div>

                <!-- Seguridad del Sistema -->
                <div class="admin-option">
                    <h4><i class="fas fa-shield-alt"></i> Seguridad del Sistema</h4>
                    <p><strong>üîí Sistema Seguro:</strong> Solo el propietario del repositorio GitHub puede realizar cambios. No se requieren contrase√±as adicionales ya que GitHub maneja toda la autenticaci√≥n.</p>
                    <ul>
                        <li>‚úÖ Solo t√∫ puedes editar los archivos (autenticaci√≥n GitHub)</li>
                        <li>‚úÖ Historial completo de cambios en GitHub</li>
                        <li>‚úÖ Posibilidad de revertir cambios si es necesario</li>
                        <li>‚úÖ Sin riesgos de seguridad adicionales</li>
                    </ul>
                </div>

                <!-- OPCI√ìN 2: Archivos que puedes editar -->
                <div class="admin-option">
                    <h4><i class="fas fa-file-code"></i> Archivos de Contenido</h4>
                    <p>Estos son los archivos que puedes editar para cambiar el contenido:</p>
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-group">
                                <li class="list-group-item">
                                    <strong>config.json</strong><br>
                                    <small>Informaci√≥n general de la instituci√≥n</small>
                                </li>
                                <li class="list-group-item">
                                    <strong>testimonios.json</strong><br>
                                    <small>Experiencias de egresados</small>
                                </li>
                                <li class="list-group-item">
                                    <strong>noticias.json</strong><br>
                                    <small>Comunicados y avisos</small>
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-group">
                                <li class="list-group-item">
                                    <strong>docentes.json</strong><br>
                                    <small>Informaci√≥n del personal</small>
                                </li>
                                <li class="list-group-item">
                                    <strong>eventos_calendario_pwa.json</strong><br>
                                    <small>Eventos y fechas importantes</small>
                                </li>
                                <li class="list-group-item">
                                    <strong>avisos_pwa.json</strong><br>
                                    <small>Avisos para la PWA</small>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- OPCI√ìN 3: GitHub Desktop -->
                <div class="admin-option">
                    <h4><i class="fab fa-github"></i> Opci√≥n 2: GitHub Desktop</h4>
                    <p>Para una experiencia m√°s c√≥moda:</p>
                    <ol>
                        <li>Descarga GitHub Desktop</li>
                        <li>Clona tu repositorio</li>
                        <li>Edita los archivos JSON con cualquier editor de texto</li>
                        <li>Haz commit y push de los cambios</li>
                    </ol>
                    <a href="https://desktop.github.com/" target="_blank" class="btn btn-admin">
                        <i class="fas fa-download"></i> Descargar GitHub Desktop
                    </a>
                </div>

                <!-- OPCI√ìN 4: Editor JSON Online -->
                <div class="admin-option">
                    <h4><i class="fas fa-code"></i> Opci√≥n 3: Editor JSON Online</h4>
                    <p>Para editar JSON de forma m√°s visual:</p>
                    <ol>
                        <li>Copia el contenido del archivo JSON desde GitHub</li>
                        <li>P√©galo en un editor JSON online</li>
                        <li>Edita visualmente</li>
                        <li>Copia el resultado y p√©galo de vuelta en GitHub</li>
                    </ol>
                    <a href="https://jsoneditoronline.org/" target="_blank" class="btn btn-admin">
                        <i class="fas fa-external-link-alt"></i> Abrir Editor JSON
                    </a>
                </div>

                <!-- Estado del Sitio -->
                <div class="admin-option">
                    <h4><i class="fas fa-chart-line"></i> Estado del Sitio</h4>
                    <p>Enlaces √∫tiles para monitorear tu sitio:</p>
                    <div class="row">
                        <div class="col-md-4">
                            <a href="https://SACRINT.github.io/heroes_de_la_patria_oficial/" target="_blank" class="btn btn-admin w-100 mb-2">
                                <i class="fas fa-globe"></i> Ver Sitio Web
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="https://github.com/SACRINT/heroes_de_la_patria_oficial" target="_blank" class="btn btn-admin w-100 mb-2">
                                <i class="fab fa-github"></i> Ver Repositorio
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="https://github.com/SACRINT/heroes_de_la_patria_oficial/commits/main" target="_blank" class="btn btn-admin w-100 mb-2">
                                <i class="fas fa-history"></i> Ver Cambios
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Script para cerrar sesi√≥n -->
    <script>
        // Funci√≥n para cerrar sesi√≥n y cerrar ventana
        function logoutAndClose() {
            console.log('üîê Iniciando logout desde manual.html...');
            
            // Acceder al localStorage del parent (ventana principal)
            if (window.opener) {
                try {
                    console.log('‚úÖ Ventana padre encontrada, ejecutando logout...');
                    
                    // Llamar a la funci√≥n de logout del sistema principal
                    if (window.opener.adminAuth && window.opener.adminAuth.logout) {
                        console.log('‚úÖ Ejecutando logout completo del sistema...');
                        window.opener.adminAuth.logout();
                        
                        // Forzar actualizaci√≥n adicional despu√©s del logout
                        setTimeout(() => {
                            if (window.opener.adminAuth) {
                                window.opener.adminAuth.updateUI();
                                console.log('üîÑ UI actualizada en ventana padre');
                            }
                        }, 500);
                    } else if (window.opener.logoutAdminPanel) {
                        console.log('‚úÖ Ejecutando logout usando funci√≥n global...');
                        window.opener.logoutAdminPanel();
                    } else {
                        console.log('‚ö†Ô∏è Fallback: limpiando localStorage directamente...');
                        // Fallback: limpiar localStorage directamente con la clave correcta
                        window.opener.localStorage.removeItem('admin_session');
                        
                        // Forzar actualizaci√≥n de elementos en la ventana padre
                        if (window.opener.document) {
                            const adminElements = window.opener.document.querySelectorAll('.admin-only, .admin-element');
                            adminElements.forEach(element => {
                                element.style.display = 'none';
                            });
                            
                            // Ocultar bot√≥n de logout si existe
                            const logoutBtn = window.opener.document.querySelector('a[onclick*="logout"], button[onclick*="logout"]');
                            if (logoutBtn) {
                                logoutBtn.style.display = 'none';
                            }
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error accediendo a ventana padre:', error);
                    // Limpiar el localStorage local como fallback
                    localStorage.removeItem('admin_session');
                }
            } else {
                console.log('‚ö†Ô∏è No hay ventana padre, limpiando localStorage local...');
                // No hay ventana padre, limpiar localStorage local
                localStorage.removeItem('admin_session');
            }
            
            // Forzar actualizaci√≥n de UI en la ventana padre INMEDIATAMENTE
            if (window.opener && window.opener.adminAuth) {
                console.log('üîÑ Forzando actualizaci√≥n inmediata de UI en ventana padre...');
                window.opener.adminAuth.updateUI();

                // M√∫ltiples intentos de actualizaci√≥n para garantizar que se aplique
                setTimeout(() => window.opener.adminAuth.updateUI(), 100);
                setTimeout(() => window.opener.adminAuth.updateUI(), 300);
                setTimeout(() => window.opener.adminAuth.updateUI(), 500);
            }

            // SEGURIDAD: Redirigir ventana padre a index.html si es dashboard
            if (window.opener && window.opener.location) {
                const openerUrl = window.opener.location.href;
                console.log('üîç Ventana padre URL:', openerUrl);

                // Si la ventana padre es el dashboard, redirigirla por seguridad
                if (openerUrl.includes('admin-dashboard.html') || openerUrl.includes('dashboard')) {
                    console.log('üîí SEGURIDAD: Cerrando dashboard y redirigiendo a index.html...');
                    setTimeout(() => {
                        // Redirigir la ventana padre al index
                        window.opener.location.href = window.opener.location.origin + '/index.html';
                    }, 1000);
                }
            }
            
            // Mostrar mensaje y manejar cierre
            alert('Sesi√≥n cerrada correctamente. Esta ventana se cerrar√°.');
            setTimeout(() => {
                // Intentar cerrar como ventana emergente primero
                try {
                    if (window.opener) {
                        console.log('üö™ Cerrando ventana popup...');
                        window.close();
                        
                        // Verificar si se cerr√≥, si no, intentar otras opciones
                        setTimeout(() => {
                            if (!window.closed) {
                                console.log('‚ö†Ô∏è No se pudo cerrar como popup, intentando alternativas...');
                                // Solo si falla el cierre, redirigir
                                window.location.href = '../index.html';
                            }
                        }, 500);
                    } else {
                        // No hay ventana padre, es una pesta√±a normal
                        console.log('üìÑ Es una pesta√±a normal, redirigiendo...');
                        window.location.href = '../index.html';
                    }
                } catch (error) {
                    console.error('‚ùå Error al cerrar ventana:', error);
                    window.location.href = '../index.html';
                }
            }, 1000);
        }
        
        // Variable global para almacenar datos de autenticaci√≥n
        let authData = null;
        
        // Escuchar mensajes de la ventana padre
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'AUTH_DATA') {
                console.log('‚úÖ Datos de autenticaci√≥n recibidos desde ventana padre:', event.data);
                authData = event.data;
                // Marcar como autenticado inmediatamente
                isAuthenticated = event.data.authenticated;
            }
        });
        
        // Verificar estado de sesi√≥n al cargar la p√°gina
        function checkSessionStatus() {
            let isAuthenticated = false;
            
            // Primero verificar si recibimos datos de la ventana padre
            if (authData && authData.authenticated) {
                console.log('‚úÖ Autenticaci√≥n v√°lida desde ventana padre');
                return; // Salir temprano, ya estamos autenticados
            }
            
            try {
                // Intentar verificar en la ventana padre primero (nuevo sistema)
                if (window.opener && window.opener.localStorage) {
                    const newAuthData = window.opener.localStorage.getItem('secure_admin_session');
                    if (newAuthData) {
                        const data = JSON.parse(newAuthData);
                        isAuthenticated = data.token && data.expiresAt && (Date.now() < data.expiresAt);
                        console.log('üîç Verificando sesi√≥n nueva:', isAuthenticated);
                    }
                    
                    // Fallback al sistema viejo
                    if (!isAuthenticated) {
                        const oldAuthData = window.opener.localStorage.getItem('admin_session');
                        if (oldAuthData) {
                            const data = JSON.parse(oldAuthData);
                            const sessionTimeout = 30 * 60 * 1000; // 30 minutos
                            isAuthenticated = data.timestamp && (Date.now() - data.timestamp < sessionTimeout);
                            console.log('üîç Verificando sesi√≥n vieja:', isAuthenticated);
                        }
                    }
                } else {
                    // Verificar en localStorage local (nuevo sistema)
                    const newAuthData = localStorage.getItem('secure_admin_session');
                    if (newAuthData) {
                        const data = JSON.parse(newAuthData);
                        isAuthenticated = data.token && data.expiresAt && (Date.now() < data.expiresAt);
                    }
                    
                    // Fallback al sistema viejo
                    if (!isAuthenticated) {
                        const oldAuthData = localStorage.getItem('admin_session');
                        if (oldAuthData) {
                            const data = JSON.parse(oldAuthData);
                            const sessionTimeout = 30 * 60 * 1000; // 30 minutos
                            isAuthenticated = data.timestamp && (Date.now() - data.timestamp < sessionTimeout);
                        }
                    }
                }
            } catch (error) {
                console.warn('Error verificando sesi√≥n:', error);
                isAuthenticated = false;
            }
            
            // Si no hay sesi√≥n activa, esperar un poco m√°s por si llegan datos de la ventana padre
            if (!isAuthenticated) {
                console.log('‚è∞ Esperando datos de autenticaci√≥n de ventana padre...');
                
                // Esperar 2 segundos antes de mostrar error
                setTimeout(() => {
                    if (!authData || !authData.authenticated) {
                        alert('Sesi√≥n expirada o no v√°lida. Ser√°s redirigido al inicio.');
                        setTimeout(() => {
                            if (window.opener) {
                                window.close();
                            } else {
                                window.location.href = '../index.html';
                            }
                        }, 2000);
                    }
                }, 2000);
            }
        }
        
        // Verificar sesi√≥n cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', checkSessionStatus);
        
        // Verificar sesi√≥n peri√≥dicamente (cada 5 minutos)
        setInterval(checkSessionStatus, 5 * 60 * 1000);
        
        // Comunicaci√≥n bidireccional con la ventana padre
        window.addEventListener('beforeunload', function(event) {
            console.log('üö™ Ventana manual.html cerr√°ndose, actualizando UI padre...');
            if (window.opener && window.opener.adminAuth) {
                try {
                    window.opener.adminAuth.updateUI();
                    console.log('‚úÖ UI de ventana padre actualizada antes de cerrar');
                } catch (error) {
                    console.warn('‚ö†Ô∏è No se pudo actualizar UI padre:', error);
                }
            }
        });
        
        // Actualizaci√≥n peri√≥dica de estado con ventana padre (cada 5 segundos)
        setInterval(() => {
            if (window.opener && !window.opener.closed && window.opener.adminAuth) {
                // Verificar que el estado est√© sincronizado
                const localAuth = localStorage.getItem('admin_session');
                const parentAuth = window.opener.localStorage.getItem('admin_session');
                
                if (localAuth !== parentAuth) {
                    console.log('üîÑ Sincronizando estado de autenticaci√≥n con ventana padre...');
                    if (parentAuth) {
                        localStorage.setItem('admin_session', parentAuth);
                    } else {
                        localStorage.removeItem('admin_session');
                    }
                }
            }
        }, 5000);
    </script>
</body>
</html>