---
import { Layout } from '@heroes-patria/ui';
import { siteConfig } from '@heroes-patria/config';

const pageTitle = 'Centro de Descargas';
const pageDescription = 'Accede a todos los documentos importantes, formatos, reglamentos y recursos acad√©micos del Bachillerato H√©roes de la Patria "H√©roes de Puebla".';
---

<Layout title={pageTitle} description={pageDescription}>
  <div class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">
    <!-- Hero Section -->
    <section class="relative py-16 px-6">
      <div class="absolute inset-0 bg-gradient-to-r from-blue-600/10 to-indigo-600/10"></div>
      <div class="relative max-w-6xl mx-auto text-center">
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-6">
          Centro de <span class="text-blue-600">Descargas</span>
        </h1>
        <p class="text-xl text-gray-600 max-w-3xl mx-auto mb-8">
          Encuentra todos los documentos importantes, formatos, reglamentos y recursos acad√©micos
          que necesitas para tu trayectoria educativa en el Bachillerato H√©roes de la Patria.
        </p>
        
        <!-- Search and Filters -->
        <div class="bg-white/70 backdrop-blur-md rounded-2xl p-6 shadow-lg border border-white/20 max-w-4xl mx-auto">
          <div class="flex flex-col md:flex-row gap-4 mb-4">
            <div class="flex-1">
              <input type="text" id="searchInput" placeholder="Buscar documentos..." 
                     class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <select id="categoryFilter" class="px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500">
              <option value="all">Todas las categor√≠as</option>
              <option value="formatos">Formatos y Solicitudes</option>
              <option value="reglamentos">Reglamentos</option>
              <option value="academicos">Documentos Acad√©micos</option>
              <option value="administrativos">Administrativos</option>
              <option value="estudiantes">Para Estudiantes</option>
              <option value="padres">Para Padres de Familia</option>
            </select>
            <select id="typeFilter" class="px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500">
              <option value="all">Todos los tipos</option>
              <option value="pdf">PDF</option>
              <option value="doc">Word</option>
              <option value="xls">Excel</option>
            </select>
          </div>
        </div>
      </div>
    </section>

    <!-- Downloads Categories -->
    <section class="py-12 px-6">
      <div class="max-w-6xl mx-auto">
        <div id="documentsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Documents will be loaded here by JavaScript -->
        </div>

        <!-- No Results Message -->
        <div id="noResults" class="hidden text-center py-12">
          <div class="text-gray-400 text-6xl mb-4">üìÑ</div>
          <h3 class="text-xl font-semibold text-gray-600 mb-2">No se encontraron documentos</h3>
          <p class="text-gray-500">Intenta ajustar tus filtros de b√∫squeda</p>
        </div>
      </div>
    </section>

    <!-- Quick Access Section -->
    <section class="py-16 px-6 bg-gradient-to-r from-blue-600 to-indigo-600">
      <div class="max-w-6xl mx-auto text-center text-white">
        <h2 class="text-3xl font-bold mb-8">Acceso R√°pido</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20 hover:bg-white/20 transition-all cursor-pointer" onclick="filterByCategory('formatos')">
            <div class="text-3xl mb-4">üìã</div>
            <h3 class="font-semibold mb-2">Formatos</h3>
            <p class="text-sm opacity-90">Solicitudes y tr√°mites</p>
          </div>
          <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20 hover:bg-white/20 transition-all cursor-pointer" onclick="filterByCategory('reglamentos')">
            <div class="text-3xl mb-4">üìö</div>
            <h3 class="font-semibold mb-2">Reglamentos</h3>
            <p class="text-sm opacity-90">Normas y pol√≠ticas</p>
          </div>
          <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20 hover:bg-white/20 transition-all cursor-pointer" onclick="filterByCategory('academicos')">
            <div class="text-3xl mb-4">üéì</div>
            <h3 class="font-semibold mb-2">Acad√©micos</h3>
            <p class="text-sm opacity-90">Programas y planes</p>
          </div>
          <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20 hover:bg-white/20 transition-all cursor-pointer" onclick="filterByCategory('estudiantes')">
            <div class="text-3xl mb-4">üë®‚Äçüéì</div>
            <h3 class="font-semibold mb-2">Estudiantes</h3>
            <p class="text-sm opacity-90">Recursos y gu√≠as</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Help Section -->
    <section class="py-12 px-6 bg-white/50">
      <div class="max-w-4xl mx-auto text-center">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">¬øNecesitas ayuda?</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="text-left">
            <h3 class="font-semibold text-lg mb-3">üîç C√≥mo buscar documentos</h3>
            <ul class="text-gray-600 space-y-2">
              <li>‚Ä¢ Usa la barra de b√∫squeda para encontrar documentos espec√≠ficos</li>
              <li>‚Ä¢ Filtra por categor√≠a para ver solo documentos de tu inter√©s</li>
              <li>‚Ä¢ Selecciona el tipo de archivo que prefieres</li>
              <li>‚Ä¢ Haz clic en "Acceso R√°pido" para categor√≠as populares</li>
            </ul>
          </div>
          <div class="text-left">
            <h3 class="font-semibold text-lg mb-3">‚ùì ¬øNo encuentras lo que buscas?</h3>
            <p class="text-gray-600 mb-4">
              Si no encuentras el documento que necesitas, puedes contactarnos:
            </p>
            <div class="space-y-2 text-sm text-gray-600">
              <p>üìû <strong>Tel√©fono:</strong> (222) 555-0166</p>
              <p>üìß <strong>Email:</strong> contacto@heroespatria.edu.mx</p>
              <p>üïí <strong>Horario:</strong> Lunes a Viernes 7:00 - 15:00</p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</Layout>

<script>
// Document data structure
const documents = [
  // Formatos y Solicitudes
  {
    id: 1,
    title: "Solicitud de Constancia de Estudios",
    description: "Formato para solicitar constancia de estudios vigente",
    category: "formatos",
    type: "pdf",
    size: "245 KB",
    downloadCount: 1250,
    lastUpdated: "2024-08-15",
    tags: ["constancia", "estudios", "tr√°mite"]
  },
  {
    id: 2,
    title: "Solicitud de Beca",
    description: "Formato oficial para solicitud de becas acad√©micas y socioecon√≥micas",
    category: "formatos",
    type: "pdf",
    size: "320 KB",
    downloadCount: 890,
    lastUpdated: "2024-08-20",
    tags: ["beca", "apoyo", "econ√≥mico"]
  },
  {
    id: 3,
    title: "Solicitud de Reinscripci√≥n",
    description: "Formato para tr√°mite de reinscripci√≥n semestral",
    category: "formatos",
    type: "pdf",
    size: "180 KB",
    downloadCount: 2100,
    lastUpdated: "2024-08-10",
    tags: ["reinscripci√≥n", "semestre", "tr√°mite"]
  },
  {
    id: 4,
    title: "Carta de No Adeudo",
    description: "Formato para solicitar carta de no adeudo bibliotecario",
    category: "formatos",
    type: "doc",
    size: "95 KB",
    downloadCount: 450,
    lastUpdated: "2024-07-25",
    tags: ["no adeudo", "biblioteca", "carta"]
  },

  // Reglamentos
  {
    id: 5,
    title: "Reglamento Escolar Interno",
    description: "Reglamento oficial del plantel con normas y procedimientos",
    category: "reglamentos",
    type: "pdf",
    size: "1.2 MB",
    downloadCount: 3200,
    lastUpdated: "2024-08-01",
    tags: ["reglamento", "normas", "disciplina"]
  },
  {
    id: 6,
    title: "Manual de Convivencia",
    description: "Gu√≠a para la sana convivencia en la comunidad escolar",
    category: "reglamentos",
    type: "pdf",
    size: "850 KB",
    downloadCount: 1800,
    lastUpdated: "2024-07-15",
    tags: ["convivencia", "manual", "comunidad"]
  },
  {
    id: 7,
    title: "Protocolo de Seguridad",
    description: "Protocolo de seguridad y emergencias del plantel",
    category: "reglamentos",
    type: "pdf",
    size: "650 KB",
    downloadCount: 750,
    lastUpdated: "2024-06-30",
    tags: ["seguridad", "emergencias", "protocolo"]
  },

  // Documentos Acad√©micos
  {
    id: 8,
    title: "Plan de Estudios Bachillerato",
    description: "Plan de estudios completo del bachillerato tecnol√≥gico",
    category: "academicos",
    type: "pdf",
    size: "2.1 MB",
    downloadCount: 2800,
    lastUpdated: "2024-08-25",
    tags: ["plan estudios", "bachillerato", "curriculum"]
  },
  {
    id: 9,
    title: "Especialidad en Inform√°tica",
    description: "Programa acad√©mico de la especialidad en Inform√°tica",
    category: "academicos",
    type: "pdf",
    size: "980 KB",
    downloadCount: 1200,
    lastUpdated: "2024-08-20",
    tags: ["inform√°tica", "especialidad", "tecnolog√≠a"]
  },
  {
    id: 10,
    title: "Especialidad en Contabilidad",
    description: "Programa acad√©mico de la especialidad en Contabilidad",
    category: "academicos",
    type: "pdf",
    size: "920 KB",
    downloadCount: 980,
    lastUpdated: "2024-08-20",
    tags: ["contabilidad", "especialidad", "finanzas"]
  },
  {
    id: 11,
    title: "Especialidad en Electricidad",
    description: "Programa acad√©mico de la especialidad en Electricidad",
    category: "academicos",
    type: "pdf",
    size: "1.1 MB",
    downloadCount: 750,
    lastUpdated: "2024-08-20",
    tags: ["electricidad", "especialidad", "t√©cnico"]
  },
  {
    id: 12,
    title: "Calendario Acad√©mico 2024-2025",
    description: "Calendario oficial del ciclo escolar con fechas importantes",
    category: "academicos",
    type: "pdf",
    size: "420 KB",
    downloadCount: 4100,
    lastUpdated: "2024-08-30",
    tags: ["calendario", "fechas", "acad√©mico"]
  },

  // Administrativos
  {
    id: 13,
    title: "Directorio de Personal",
    description: "Directorio actualizado del personal docente y administrativo",
    category: "administrativos",
    type: "pdf",
    size: "380 KB",
    downloadCount: 650,
    lastUpdated: "2024-08-15",
    tags: ["directorio", "personal", "contactos"]
  },
  {
    id: 14,
    title: "Organigrama Institucional",
    description: "Estructura organizacional del plantel",
    category: "administrativos",
    type: "pdf",
    size: "280 KB",
    downloadCount: 520,
    lastUpdated: "2024-07-10",
    tags: ["organigrama", "estructura", "organizaci√≥n"]
  },

  // Para Estudiantes
  {
    id: 15,
    title: "Gu√≠a del Estudiante",
    description: "Manual completo con informaci√≥n esencial para estudiantes",
    category: "estudiantes",
    type: "pdf",
    size: "1.8 MB",
    downloadCount: 3500,
    lastUpdated: "2024-08-28",
    tags: ["gu√≠a", "estudiante", "manual"]
  },
  {
    id: 16,
    title: "Horarios de Clases",
    description: "Horarios actualizados por semestre y especialidad",
    category: "estudiantes",
    type: "xls",
    size: "150 KB",
    downloadCount: 2200,
    lastUpdated: "2024-08-25",
    tags: ["horarios", "clases", "semestre"]
  },
  {
    id: 17,
    title: "Gu√≠a de Servicios Estudiantiles",
    description: "Informaci√≥n sobre todos los servicios disponibles para estudiantes",
    category: "estudiantes",
    type: "pdf",
    size: "780 KB",
    downloadCount: 1600,
    lastUpdated: "2024-08-12",
    tags: ["servicios", "estudiantes", "apoyo"]
  },

  // Para Padres de Familia
  {
    id: 18,
    title: "Manual para Padres de Familia",
    description: "Gu√≠a informativa para padres sobre procesos y servicios",
    category: "padres",
    type: "pdf",
    size: "1.4 MB",
    downloadCount: 2400,
    lastUpdated: "2024-08-18",
    tags: ["padres", "familia", "informaci√≥n"]
  },
  {
    id: 19,
    title: "Calendario de Juntas con Padres",
    description: "Fechas programadas para reuniones con padres de familia",
    category: "padres",
    type: "pdf",
    size: "320 KB",
    downloadCount: 1100,
    lastUpdated: "2024-08-22",
    tags: ["juntas", "padres", "reuniones"]
  },
  {
    id: 20,
    title: "Gu√≠a de Apoyo Acad√©mico",
    description: "Informaci√≥n sobre c√≥mo apoyar el rendimiento acad√©mico de sus hijos",
    category: "padres",
    type: "pdf",
    size: "650 KB",
    downloadCount: 850,
    lastUpdated: "2024-07-20",
    tags: ["apoyo", "acad√©mico", "padres"]
  }
];

let filteredDocuments = [...documents];

// Utility functions
function getFileIcon(type) {
  const icons = {
    pdf: 'üìÑ',
    doc: 'üìù',
    xls: 'üìä',
    default: 'üìÑ'
  };
  return icons[type] || icons.default;
}

function getCategoryBadge(category) {
  const badges = {
    formatos: { color: 'bg-blue-100 text-blue-800', text: 'Formatos' },
    reglamentos: { color: 'bg-red-100 text-red-800', text: 'Reglamentos' },
    academicos: { color: 'bg-green-100 text-green-800', text: 'Acad√©micos' },
    administrativos: { color: 'bg-yellow-100 text-yellow-800', text: 'Administrativos' },
    estudiantes: { color: 'bg-purple-100 text-purple-800', text: 'Estudiantes' },
    padres: { color: 'bg-pink-100 text-pink-800', text: 'Padres' }
  };
  return badges[category] || { color: 'bg-gray-100 text-gray-800', text: 'General' };
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('es-MX', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
}

function formatDownloads(count) {
  if (count >= 1000) {
    return (count / 1000).toFixed(1) + 'K';
  }
  return count.toString();
}

// Render functions
function renderDocument(doc) {
  const badge = getCategoryBadge(doc.category);
  const icon = getFileIcon(doc.type);
  
  return `
    <div class="bg-white/70 backdrop-blur-md rounded-xl p-6 border border-white/20 hover:shadow-lg transition-all group">
      <div class="flex items-start justify-between mb-4">
        <div class="text-3xl">${icon}</div>
        <span class="px-2 py-1 text-xs rounded-full ${badge.color}">${badge.text}</span>
      </div>
      
      <h3 class="font-semibold text-lg mb-2 group-hover:text-blue-600 transition-colors">
        ${doc.title}
      </h3>
      
      <p class="text-gray-600 text-sm mb-4 line-clamp-2">
        ${doc.description}
      </p>
      
      <div class="flex items-center justify-between text-xs text-gray-500 mb-4">
        <span>üìè ${doc.size}</span>
        <span>üì• ${formatDownloads(doc.downloadCount)}</span>
        <span>üïí ${formatDate(doc.lastUpdated)}</span>
      </div>
      
      <div class="flex gap-2 mb-4">
        ${doc.tags.slice(0, 3).map(tag => 
          `<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">#${tag}</span>`
        ).join('')}
      </div>
      
      <button onclick="downloadDocument(${doc.id})" 
              class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
        <i class="fas fa-download"></i>
        Descargar
      </button>
    </div>
  `;
}

function renderDocuments() {
  const container = document.getElementById('documentsContainer');
  const noResults = document.getElementById('noResults');
  
  if (filteredDocuments.length === 0) {
    container.innerHTML = '';
    noResults.classList.remove('hidden');
  } else {
    container.innerHTML = filteredDocuments.map(doc => renderDocument(doc)).join('');
    noResults.classList.add('hidden');
  }
}

// Filter functions
function applyFilters() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const categoryFilter = document.getElementById('categoryFilter').value;
  const typeFilter = document.getElementById('typeFilter').value;
  
  filteredDocuments = documents.filter(doc => {
    const matchesSearch = doc.title.toLowerCase().includes(searchTerm) ||
                         doc.description.toLowerCase().includes(searchTerm) ||
                         doc.tags.some(tag => tag.toLowerCase().includes(searchTerm));
    
    const matchesCategory = categoryFilter === 'all' || doc.category === categoryFilter;
    const matchesType = typeFilter === 'all' || doc.type === typeFilter;
    
    return matchesSearch && matchesCategory && matchesType;
  });
  
  renderDocuments();
}

function filterByCategory(category) {
  document.getElementById('categoryFilter').value = category;
  applyFilters();
  
  // Scroll to results
  document.getElementById('documentsContainer').scrollIntoView({ 
    behavior: 'smooth' 
  });
}

// Event handlers
async function downloadDocument(docId) {
  const doc = documents.find(d => d.id === docId);
  if (!doc) return;
  
  try {
    // Track the download attempt
    const trackResponse = await fetch(`http://localhost:3001/api/documents/${docId}/track`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    // Attempt to download the document
    const downloadResponse = await fetch(`http://localhost:3001/api/documents/${docId}/download`);
    
    if (downloadResponse.ok) {
      // Create a blob from the response
      const blob = await downloadResponse.blob();
      
      // Create a temporary URL and trigger download
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${doc.title}.${doc.type}`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      // Update download count locally
      doc.downloadCount++;
      renderDocuments();
    } else {
      // Handle download error - show sample content message
      const errorData = await downloadResponse.json();
      alert(`${doc.title}\n\n‚ö†Ô∏è Este es un documento de demostraci√≥n.\n\nEn la implementaci√≥n final, aqu√≠ se descargar√≠a el archivo real desde el servidor.\n\nError: ${errorData.message || 'Archivo no disponible'}`);
    }
  } catch (error) {
    console.error('Download error:', error);
    alert(`Error al descargar: ${doc.title}\n\nPor favor, int√©ntalo de nuevo o contacta al administrador.`);
  }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
  // Set up event listeners
  document.getElementById('searchInput').addEventListener('input', applyFilters);
  document.getElementById('categoryFilter').addEventListener('change', applyFilters);
  document.getElementById('typeFilter').addEventListener('change', applyFilters);
  
  // Initial render
  renderDocuments();
});

// Make functions globally available
window.filterByCategory = filterByCategory;
window.downloadDocument = downloadDocument;
</script>

<style>
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>